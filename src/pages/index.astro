---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Tallas">
	<main>
		<div class="card">
			<div id="formulario">
				<h2>Recomendador de tallas</h2>
				<div class="inputs">
					<div>
						<input id="talla" placeholder="Talla" type="text" />
					</div>
					<div>
						<input id="peso" placeholder="Peso" type="text" />
					</div>
					<div>
						<select id="estilo" name="estilo">
							<option value="1">Entallado</option>
							<option value="2">Normal</option>
							<option value="3">Holgado</option>
						</select>
					</div>
					<button class="btn" id="calc">Calcular</button>
				</div>
			</div>
			<div id="resultado"></div>
		</div>
	</main>

	<script>
		document.addEventListener("astro:page-load", () => {
			const calc = document.getElementById("calc") as HTMLButtonElement;
			const formulario = document.getElementById(
				"formulario",
			) as HTMLFormElement;
			const resultadoSpan = document.getElementById(
				"resultado",
			) as HTMLDivElement;

			if (!calc || !formulario || !resultadoSpan) {
				console.error(
					"No se encontró uno de los elementos necesarios en el DOM.",
				);
				return;
			}

			calc.addEventListener("click", function (event) {
				event.preventDefault();
				event.stopPropagation();

				clearErrors();

				try {
					let talla = validarCampo("talla", 100, 250);
					let peso = validarCampo("peso", 30, 200);
					let estilo = validarEstilo();

					let resultado = obtenerTallaRecomendada(
						talla,
						peso,
						estilo,
					);
					mostrarResultado(resultado);
				} catch (error) {
					mostrarError(error.message);
				}
			});

			function validarCampo(id, min, max) {
				let inputElement = document.getElementById(id);
				if (!inputElement)
					throw new Error(`No se encontró el campo ${id}.`);

				let valor = parseFloat(
					(inputElement as HTMLInputElement).value,
				);
				if (isNaN(valor) || valor < min || valor > max) {
					throw new Error(
						`Por favor, ingresa un(a) ${id} válido(a).`,
					);
				}
				return valor;
			}

			function validarEstilo() {
				let estiloElement = document.getElementById(
					"estilo",
				) as HTMLSelectElement;
				if (!estiloElement)
					throw new Error("No se encontró el campo estilo.");

				let estilo = estiloElement.value;
				if (!estilo) {
					throw new Error("Por favor, selecciona un estilo.");
				}
				return estilo;
			}

			function obtenerTallaRecomendada(talla, peso, estilo) {
				if (talla >= 150 && talla <= 170 && peso >= 50 && peso <= 65) {
					if (estilo === "1" || estilo === "2") {
						return "TALLA S";
					} else if (estilo === "3") {
						return "TALLA M";
					}
				} else if (
					talla >= 150 &&
					talla <= 175 &&
					peso >= 60 &&
					peso <= 75
				) {
					if (estilo === "1") {
						return "TALLA S";
					} else if (estilo === "2") {
						return "TALLA M";
					} else if (estilo === "3") {
						return "TALLA L";
					}
				} else if (
					talla >= 175 &&
					talla <= 185 &&
					peso >= 60 &&
					peso <= 65
				) {
					if (estilo === "1" || estilo === "2") {
						return "TALLA M";
					} else if (estilo === "3") {
						return "TALLA L";
					}
				} else if (
					talla >= 160 &&
					talla <= 185 &&
					peso >= 65 &&
					peso <= 90
				) {
					if (estilo === "1") {
						return "TALLA M";
					} else if (estilo === "2") {
						return "TALLA L";
					} else if (estilo === "3") {
						return "TALLA XL";
					}
				} else if (
					talla >= 185 &&
					talla <= 190 &&
					peso >= 65 &&
					peso <= 84
				) {
					if (estilo === "1") {
						return "TALLA L";
					} else if (estilo === "2" || estilo === "3") {
						return "TALLA XL";
					}
				} else if (
					talla >= 160 &&
					talla <= 190 &&
					peso >= 85 &&
					peso <= 95
				) {
					if (estilo === "1") {
						return "TALLA L";
					} else if (estilo === "2" || estilo === "3") {
						return "TALLA XL";
					}
				} else if (talla > 190 && peso >= 96 && peso <= 100) {
					return "XXL_NO_DISPONIBLE";
				} else if (talla <= 149 && peso <= 49) {
					return "XS_NO_DISPONIBLE";
				} else {
					return "FUERA_DE_RANGO";
				}
			}

			function mostrarResultado(resultado) {
				formulario.classList.add("blur");
				let mensajeHTML = "";

				if (resultado === "XXL_NO_DISPONIBLE") {
					mensajeHTML = `<div style="font-size: 18px; line-height: 1.5;">Al parecer, tu talla es XXL y aún no está disponible en nuestra tienda.<br>¡Esperamos tenerla pronto!</div>`;
				} else if (resultado === "XS_NO_DISPONIBLE") {
					mensajeHTML = `<div style="font-size: 18px; line-height: 1.5;">Al parecer, tu talla es XS y aún no está disponible en nuestra tienda.<br>¡Esperamos tenerla pronto!</div>`;
				} else if (resultado === "FUERA_DE_RANGO") {
					mensajeHTML = `<div style="font-size: 18px; line-height: 1.5;">Lo sentimos, tus medidas están fuera del rango de nuestras tallas disponibles.</div>`;
				} else {
					mensajeHTML = `<div style="font-size: 18px; line-height: 1.5;">
            Después de analizar tus medidas y estilo, te recomendamos: <br> <b>${resultado}</b></div>`;
				}

				resultadoSpan.innerHTML = mensajeHTML;
				resultadoSpan.style.display = "block";
			}

			function mostrarError(mensaje) {
				formulario.classList.add("blur");
				resultadoSpan.innerHTML = `<div style="font-size: 18px; line-height: 1.5; color: red;"><b>${mensaje}</b></div>`;
				resultadoSpan.style.display = "block";
			}

			function clearErrors() {
				resultadoSpan.style.display = "none";
				formulario.classList.remove("blur");
			}

			document.addEventListener("click", function () {
				if (formulario.classList.contains("blur")) {
					formulario.classList.remove("blur");
					resultadoSpan.style.display = "none";
				}
			});

			resultadoSpan.addEventListener("click", function (event) {
				event.stopPropagation();
			});
		});
	</script>
</Layout>
<style>
	main {
		position: absolute;
		width: 90%;
		left: calc(50% - 45%);
		top: 6rem;
	}

	.card {
		border: 1px solid var(--accent-color-3);
		width: 75%;
		margin: 0 auto;
	}

	.inputs {
		width: 80%;
		margin: 0 auto;
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	#formulario.blur {
		filter: blur(5px);
	}

	#resultado {
		display: none;
		position: relative;
		left: 50%;
		transform: translateX(-50%);
		top: -10rem;
		background-color: rgba(255, 255, 255, 0.8);
		padding: 20px;
		border-radius: 10px;
		text-align: center;
		font-size: 20px;
	}
	@media (max-width: 768px) {
		input {
			width: 90%;
		}

		select {
			width: 93%;
			margin: 0 calc(50% - 46.5%);
		}
		.btn {
			width: 80%;
		}
		#resultado {
			top: -16rem;
		}
	}
</style>
